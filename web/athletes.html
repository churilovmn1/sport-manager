<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Список спортсменов</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .form-container { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; display: none; background: white; }
        input, select { margin-bottom: 10px; padding: 8px; width: 100%; box-sizing: border-box; }
        button { padding: 8px 15px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Спортсмены</h1>
        <div>
            <button onclick="toggleForm()">+ Добавить</button>
            <button onclick="window.location.href = 'index.html'">В меню</button>
        </div>
    </div>
    
    <div id="editFormContainer" class="form-container">
        <h2 id="formTitle">Карточка спортсмена</h2>
        <form id="athleteForm">
            <input type="hidden" id="athleteId">
            <input type="text" id="fullName" placeholder="ФИО" required>
            <input type="date" id="birthDate" required> 
            <select id="genderSelect">
                <option value="m">Мужской (M)</option>
                <option value="f">Женский (F)</option>
            </select>
            <input type="text" id="address" placeholder="Адрес" required>
            <button type="submit">Сохранить</button>
            <button type="button" onclick="toggleForm()">Отмена</button>
        </form>
    </div>
    
    <div id="athleteList">Загрузка...</div>

    <script>
        const API = 'http://localhost:8080/api/v1';
        const h = () => ({ 'Authorization': `Bearer ${localStorage.getItem('token')}`, 'Content-Type': 'application/json' });

        async function fetchAthletes() {
            try {
                const res = await fetch(`${API}/athletes`, { headers: h() });
                if (res.status === 401) window.location.replace('login.html');
                const data = await res.json();
                renderAthletes(data.athletes || data);
            } catch (e) { document.getElementById('athleteList').innerText = "Ошибка доступа"; }
        }

        function renderAthletes(list) {
            let html = '<table><tr><th>ФИО</th><th>Дата рожд.</th><th>Пол</th><th>Адрес</th><th>Действия</th></tr>';
            (list || []).forEach(a => {
                html += `<tr>
                    <td>${a.full_name}</td>
                    <td>${new Date(a.birth_date).toLocaleDateString()}</td>
                    <td>${a.gender === 'm' ? 'М' : 'Ж'}</td>
                    <td>${a.address}</td>
                    <td>
                        <button onclick="editAth(${a.id})">Ред.</button>
                        <button style="color:red" onclick="delAth(${a.id})">Удалить</button>
                    </td>
                </tr>`;
            });
            document.getElementById('athleteList').innerHTML = html + '</table>';
        }

        function toggleForm() {
            const f = document.getElementById('editFormContainer');
            f.style.display = f.style.display === 'block' ? 'none' : 'block';
            if (f.style.display === 'none') document.getElementById('athleteForm').reset();
        }

        async function editAth(id) {
            const res = await fetch(`${API}/athletes/${id}`, { headers: h() });
            if (res.ok) {
                const a = await res.json();
                document.getElementById('athleteId').value = a.id;
                document.getElementById('fullName').value = a.full_name;
                document.getElementById('birthDate').value = a.birth_date.split('T')[0];
                document.getElementById('genderSelect').value = a.gender;
                document.getElementById('address').value = a.address;
                document.getElementById('editFormContainer').style.display = 'block';
            }
        }

        async function delAth(id) {
            if (confirm('Удалить?')) {
                await fetch(`${API}/athletes/${id}`, { method: 'DELETE', headers: h() });
                fetchAthletes();
            }
        }

        document.getElementById('athleteForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('athleteId').value;
            const body = {
                full_name: document.getElementById('fullName').value,
                birth_date: new Date(document.getElementById('birthDate').value).toISOString(),
                gender: document.getElementById('genderSelect').value,
                address: document.getElementById('address').value
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API}/athletes/${id}` : `${API}/athletes`;
            const res = await fetch(url, { method, headers: h(), body: JSON.stringify(body) });
            if (res.ok) { toggleForm(); fetchAthletes(); } else { alert("Ошибка сохранения"); }
        };

        window.onload = fetchAthletes;
    </script>
</body>
</html>