<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление участниками соревнований</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-container, .list-container { 
            border: 1px solid #ccc; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 8px;
        }
        select, button { padding: 10px; margin-right: 10px; }
        #error { color: red; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #5cb85c; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Управление участниками соревнований</h1>
        <div>
            <button onclick="window.location.href = 'home.html'">На главную</button>
            <button onclick="logout()">Выход</button>
        </div>
    </div>

    <div class="form-container">
        <h2>Регистрация спортсмена на соревнование</h2>
        <form id="addParticipationForm">
            <p>Выберите соревнование:</p>
            <select id="competitionSelect" required>
                <option value="">-- Загрузка соревнований... --</option>
            </select>
            
            <p>Выберите спортсмена:</p>
            <select id="athleteSelect" required>
                <option value="">-- Загрузка спортсменов... --</option>
            </select>
            
            <br><br>
            <button type="submit">Зарегистрировать участника</button>
        </form>
        <p id="participationStatus" style="color: blue; font-weight: bold;"></p>
        <p id="error"></p>
    </div>

    <div class="list-container">
        <h2>Текущие участники</h2>
        <div id="participationList">Загрузка участников...</div>
    </div>


    <script>
        const API_BASE_URL = 'http://localhost:8080/api/v1';

        function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            return token;
        }

        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'login.html';
        }

        // --- Загрузка данных для Dropdown'ов ---

        async function fetchOptions(endpoint, selectId) {
            const token = checkAuth();
            if (!token) return;

            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Загрузка... --</option>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error(`Ошибка ${response.status} при загрузке ${endpoint}`);
                
                let data = await response.json();
                
                // Если API возвращает объект с полем athletes или competitions
                if (data.athletes) data = data.athletes;
                if (data.competitions) data = data.competitions;
                
                select.innerHTML = '<option value="">-- Выберите --</option>';
                data.forEach(item => {
                    const name = item.full_name || item.name; // Используем full_name для спортсменов и name для соревнований
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.id}: ${name}`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error(`Ошибка загрузки ${endpoint}:`, error);
                document.getElementById('error').textContent = `Ошибка загрузки: ${error.message}`;
                select.innerHTML = '<option value="">-- Ошибка загрузки --</option>';
            }
        }

        // --- Добавление участника (POST) ---

        async function addParticipation(e) {
            e.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const statusElement = document.getElementById('participationStatus');
            const errorElement = document.getElementById('error');
            statusElement.textContent = 'Отправка...';
            errorElement.textContent = '';

            const data = {
                athlete_id: parseInt(document.getElementById('athleteSelect').value),
                competition_id: parseInt(document.getElementById('competitionSelect').value),
            };

            if (!data.athlete_id || !data.competition_id) {
                errorElement.textContent = 'Пожалуйста, выберите и спортсмена, и соревнование.';
                statusElement.textContent = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/participations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`, 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                const responseText = await response.text();
                const result = responseText ? JSON.parse(responseText) : {};

                if (!response.ok) {
                    const msg = result.error || result.message || response.statusText;
                    throw new Error(`Ошибка ${response.status}: ${msg}`);
                }
                
                statusElement.textContent = `УСПЕХ! Участник зарегистрирован (ID: ${result.id || data.athlete_id}).`;
                document.getElementById('addParticipationForm').reset();
                fetchParticipations(); // Обновить список после успеха
                
            } catch (error) {
                errorElement.textContent = `Ошибка: ${error.message}`;
                statusElement.textContent = 'Регистрация не удалась.';
            }
        }
        
        // --- Загрузка и отображение списка участников ---

        async function fetchParticipations() {
            const token = checkAuth();
            if (!token) return;

            const listElement = document.getElementById('participationList');
            listElement.innerHTML = 'Загрузка списка участников...';

            try {
                const response = await fetch(`${API_BASE_URL}/participations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error(`Ошибка ${response.status} при загрузке участников`);
                
                const participations = await response.json();
                renderParticipations(participations);

            } catch (error) {
                document.getElementById('error').textContent = `Ошибка: ${error.message}`;
                listElement.innerHTML = 'Не удалось загрузить список участников.';
            }
        }

        function renderParticipations(participations) {
            const listElement = document.getElementById('participationList');
            
            if (!Array.isArray(participations) || participations.length === 0) {
                listElement.innerHTML = '<p>Нет зарегистрированных участников.</p>';
                return;
            }

            let tableHTML = '<table>';
            tableHTML += '<tr><th>ID</th><th>Спортсмен (ID)</th><th>Соревнование (ID)</th><th>Место</th><th>Дисквалификация</th></tr>';

            participations.forEach(p => {
                const place = p.result_place === null ? '—' : p.result_place;
                const dq = p.is_disqualified ? 'Да' : 'Нет';

                tableHTML += `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.athlete_name || p.athlete_id}</td>
                        <td>${p.competition_name || p.competition_id}</td>
                        <td>${place}</td>
                        <td>${dq}</td>
                    </tr>
                `;
            });

            tableHTML += '</table>';
            listElement.innerHTML = tableHTML;
        }

        // --- Инициализация ---

        document.addEventListener('DOMContentLoaded', () => {
             // 1. Загрузка спортсменов и соревнований
             fetchOptions('competitions', 'competitionSelect');
             fetchOptions('athletes', 'athleteSelect');
             
             // 2. Загрузка списка участников
             fetchParticipations();

             // 3. Привязка формы
             document.getElementById('addParticipationForm').addEventListener('submit', addParticipation);
        });
    </script>
</body>
</html>