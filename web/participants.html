<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление участниками соревнований</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-container, .list-container { 
            border: 1px solid #ccc; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 8px;
        }
        select, button { padding: 10px; margin-right: 10px; }
        #error { color: red; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #5cb85c; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Управление участниками соревнований</h1>
        <div>
            <button onclick="window.location.href = 'athletes.html'">Список спортсменов</button>
            <button onclick="logout()">Выход</button>
        </div>
    </div>

    <div class="form-container">
        <h2>Регистрация спортсмена на соревнование</h2>
        <form id="addParticipationForm">
            <p>Выберите соревнование:</p>
            <select id="competitionSelect" required>
                <option value="">-- Загрузка соревнований... --</option>
            </select>
            
            <p>Выберите спортсмена:</p>
            <select id="athleteSelect" required>
                <option value="">-- Загрузка спортсменов... --</option>
            </select>
            
            <br><br>
            <button type="submit">Зарегистрировать участника</button>
        </form>
        <p id="participationStatus" style="color: blue; font-weight: bold;"></p>
        <p id="error"></p>
    </div>

    <div class="list-container">
        <h2>Текущие участники</h2>
        <div id="participationList">Загрузка участников...</div>
    </div>


    <script>
        const API_BASE_URL = 'http://localhost:8080/api/v1';

        function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            return token;
        }

        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'login.html';
        }

        // --- Загрузка данных для Dropdown'ов ---

        async function fetchOptions(endpoint, selectId) {
            const token = checkAuth();
            if (!token) return;

            const select = document.getElementById(selectId);
            const errorElement = document.getElementById('error');
            select.innerHTML = '<option value="">-- Загрузка... --</option>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401 || response.status === 403) {
                    logout();
                    throw new Error('Сессия истекла. Войдите снова.');
                }
                
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({ message: 'Internal Server Error' }));
                    throw new Error(`Ошибка ${response.status}: ${errorJson.message || response.statusText}`);
                }
                
                let data = await response.json();
                
                // Обработка разных форматов API (если возвращает объект с полем)
                if (data.athletes) data = data.athletes;
                if (data.competitions) data = data.competitions;
                
                select.innerHTML = '<option value="">-- Выберите --</option>';
                data.forEach(item => {
                    // Используем full_name для спортсменов и name для соревнований
                    const name = item.full_name || item.name || `(ID: ${item.id})`; 
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${name}`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error(`Ошибка загрузки ${endpoint}:`, error);
                errorElement.textContent = `Ошибка загрузки ${endpoint}: ${error.message}`;
                select.innerHTML = '<option value="">-- Ошибка загрузки --</option>';
            }
        }

        // --- Добавление участника (POST) ---

        async function addParticipation(e) {
            e.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const statusElement = document.getElementById('participationStatus');
            const errorElement = document.getElementById('error');
            statusElement.textContent = 'Отправка...';
            errorElement.textContent = '';

            const data = {
                athlete_id: parseInt(document.getElementById('athleteSelect').value),
                competition_id: parseInt(document.getElementById('competitionSelect').value),
            };

            if (!data.athlete_id || !data.competition_id) {
                errorElement.textContent = 'Пожалуйста, выберите и спортсмена, и соревнование.';
                statusElement.textContent = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/participations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`, 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                const responseText = await response.text();
                let result = {};
                
                try {
                    result = responseText ? JSON.parse(responseText) : {};
                } catch (e) {
                    // Если сервер вернул не-JSON ошибку
                    result = { error: responseText || response.statusText };
                }


                if (!response.ok) {
                    const msg = result.error || result.message || response.statusText;
                    throw new Error(`Ошибка ${response.status}: ${msg}`);
                }
                
                statusElement.textContent = `УСПЕХ! Участник зарегистрирован (ID: ${result.id || data.athlete_id}).`;
                document.getElementById('addParticipationForm').reset();
                fetchParticipations(); // Обновить список после успеха
                
            } catch (error) {
                errorElement.textContent = `Ошибка: ${error.message}`;
                statusElement.textContent = 'Регистрация не удалась.';
            }
        }
        
        // --- Загрузка и отображение списка участников ---

        async function fetchParticipations() {
            const token = checkAuth();
            if (!token) return;

            const listElement = document.getElementById('participationList');
            const errorElement = document.getElementById('error');
            listElement.innerHTML = 'Загрузка списка участников...';
            errorElement.textContent = '';

            try {
                const response = await fetch(`${API_BASE_URL}/participations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    throw new Error('Сессия истекла. Войдите снова.');
                }

                if (!response.ok) {
                    const responseText = await response.text();
                    let errorJson = { message: 'Internal Server Error' };
                    try {
                        errorJson = JSON.parse(responseText);
                    } catch (e) {
                        errorJson.message = responseText || response.statusText;
                    }
                    throw new Error(`Ошибка ${response.status} при загрузке участников: ${errorJson.message}`);
                }
                
                const participations = await response.json();
                renderParticipations(participations);

            } catch (error) {
                errorElement.textContent = `Ошибка: ${error.message}`;
                listElement.innerHTML = 'Не удалось загрузить список участников.';
            }
        }

        function renderParticipations(participations) {
            const listElement = document.getElementById('participationList');
            
            if (!Array.isArray(participations) || participations.length === 0) {
                listElement.innerHTML = '<p>Нет зарегистрированных участников.</p>';
                return;
            }

            let tableHTML = '<table>';
            // Изменена шапка: убрана Дисквалификация
            tableHTML += '<tr><th>ID</th><th>Спортсмен (ФИО)</th><th>Соревнование (Название)</th><th>Результат (Место)</th><th>Действия</th></tr>';

            participations.forEach(p => {
                const place = p.place === 0 ? '— (Нет результата)' : p.place;
                // p.is_disqualified удалено из модели Go, поэтому убрано из HTML

                tableHTML += `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.athlete_name || p.athlete_id}</td>
                        <td>${p.competition_name || p.competition_id}</td>
                        <td>${place}</td>
                        <td>
                            <button onclick="promptForPlace(${p.id}, '${p.athlete_name || p.athlete_id}')">Обновить место</button>
                            <button onclick="deleteParticipation(${p.id})">Удалить</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</table>';
            listElement.innerHTML = tableHTML;
        }

        // --- Действия со списком ---
        
        async function promptForPlace(id, name) {
            const place = prompt(`Введите место для участника ${name} (ID: ${id}):`);
            const placeNum = parseInt(place);

            if (place !== null && !isNaN(placeNum) && placeNum >= 1) {
                await updatePlace(id, placeNum);
            } else if (place !== null) {
                alert("Неверный ввод. Место должно быть числом больше 0.");
            }
        }

        async function updatePlace(id, place) {
            const token = checkAuth();
            if (!token) return;
            
            const errorElement = document.getElementById('error');
            errorElement.textContent = '';

            try {
                const response = await fetch(`${API_BASE_URL}/participations/${id}/place`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ place: place }),
                });

                if (!response.ok) {
                    const responseText = await response.text();
                    let result = {};
                    try {
                        result = JSON.parse(responseText);
                    } catch(e) {
                        result = { error: responseText || response.statusText };
                    }
                    throw new Error(`Ошибка ${response.status}: ${result.error || result.message || response.statusText}`);
                }

                alert(`Место для участника ID ${id} обновлено на ${place}.`);
                fetchParticipations();

            } catch (error) {
                errorElement.textContent = error.message;
            }
        }
        
        async function deleteParticipation(id) {
            const token = checkAuth();
            if (!token) return;

            if (!confirm(`Вы уверены, что хотите удалить участие ID ${id}?`)) {
                return;
            }

            const errorElement = document.getElementById('error');
            errorElement.textContent = '';
            
            try {
                const response = await fetch(`${API_BASE_URL}/participations/${id}`, {
                    method: 'DELETE', 
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 404) throw new Error("Запись об участии не найдена.");
                
                if (!response.ok && response.status !== 204) {
                    const responseText = await response.text();
                    let result = {};
                    try {
                        result = JSON.parse(responseText);
                    } catch(e) {
                        result = { error: responseText || response.statusText };
                    }
                    throw new Error(`Ошибка ${response.status}: ${result.error || result.message || response.statusText}`);
                }
                
                alert(`Участие ID ${id} успешно удалено.`);
                fetchParticipations(); 

            } catch (error) {
                errorElement.textContent = error.message;
            }
        }

        // --- Инициализация ---

        document.addEventListener('DOMContentLoaded', () => {
             // 1. Загрузка спортсменов и соревнований
             // NOTE: Вам нужно убедиться, что API /competitions существует!
             fetchOptions('competitions', 'competitionSelect');
             fetchOptions('athletes', 'athleteSelect');
             
             // 2. Загрузка списка участников
             fetchParticipations();

             // 3. Привязка формы
             document.getElementById('addParticipationForm').addEventListener('submit', addParticipation);
        });
    </script>
</body>
</html>