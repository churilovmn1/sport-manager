<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Регистрация на соревнования</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #333; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        select, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 15px; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        
        .btn-add { background: #28a745; color: white; width: 100%; margin-top: 10px; padding: 12px; }
        .btn-edit { background: #ffc107; color: #212529; margin-right: 5px; padding: 5px 10px; border-radius: 4px; }
        .btn-del { background: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; }
        .back-btn { background: #6c757d; color: white; text-decoration: none; padding: 8px 15px; display: inline-block; margin-bottom: 15px; border-radius: 4px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #4e73df; color: white; }
        
        /* Модальное окно */
        #editModal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 350px; text-align: center; }
        .modal-content label { display: block; margin-top: 15px; font-weight: bold; text-align: left; }
        .modal-content select { width: 100%; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="back-btn">← В меню</a>

    <div class="card">
        <h2>Регистрация участника</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Соревнование:</label>
                <select id="compSel" style="width: 100%;"></select>
            </div>
            <div>
                <label>Спортсмен:</label>
                <select id="athSel" style="width: 100%;"></select>
            </div>
        </div>
        <button class="btn-add" onclick="register()">Добавить в список</button>
    </div>

    <div class="card">
        <h2>Список участников</h2>
        <div id="partTable">Загрузка...</div>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>Редактировать запись</h3>
        <input type="hidden" id="editId">
        
        <label>Турнир:</label>
        <select id="editCompSel"></select>

        <label>Атлет:</label>
        <select id="editAthSel"></select>

        <div style="display: flex; justify-content: space-between; margin-top: 25px; gap: 10px;">
            <button onclick="closeModal()" style="background:#6c757d; color:white; flex: 1; padding: 10px;">Отмена</button>
            <button onclick="updateParticipation()" style="background:#28a745; color:white; flex: 1; padding: 10px;">Сохранить</button>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:8080/api/v1';
    
    // Функция для получения заголовков с актуальным токеном
    const h = () => {
        const token = localStorage.getItem('token');
        if (!token) window.location.replace('login.html');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    };

    async function init() {
        await loadDropdowns();
        await loadTable();
    }

    async function loadDropdowns() {
        try {
            const [cRes, aRes] = await Promise.all([
                fetch(`${API}/competitions`, { headers: h() }),
                fetch(`${API}/athletes`, { headers: h() })
            ]);
            const cData = await cRes.json();
            const aData = await aRes.json();

            const comps = cData.competitions || cData || [];
            const aths = Array.isArray(aData) ? aData : (aData.athletes || []);

            // Заполняем селекторы (основной и в модалке)
            const compSels = [document.getElementById('compSel'), document.getElementById('editCompSel')];
            compSels.forEach(s => {
                s.innerHTML = '';
                comps.forEach(c => s.add(new Option(c.name, c.id)));
            });

            const athSels = [document.getElementById('athSel'), document.getElementById('editAthSel')];
            athSels.forEach(s => {
                s.innerHTML = '';
                aths.forEach(a => s.add(new Option(a.full_name, a.id)));
            });
        } catch (e) { console.error("Ошибка при загрузке списков", e); }
    }

    async function loadTable() {
        try {
            const res = await fetch(`${API}/participations`, { headers: h() });
            const list = await res.json();
            const data = list.participations || list || [];
            
            let html = `<table><tr><th>Атлет</th><th>Турнир</th><th>Действия</th></tr>`;
            data.forEach(p => {
                html += `<tr>
                    <td>${p.athlete_name || 'ID: '+p.athlete_id}</td>
                    <td>${p.competition_name || 'ID: '+p.competition_id}</td>
                    <td>
                        <button class="btn-edit" onclick="openModal(${p.id}, ${p.athlete_id}, ${p.competition_id})">Ред.</button>
                        <button class="btn-del" onclick="delPart(${p.id})">Удалить</button>
                    </td>
                </tr>`;
            });
            document.getElementById('partTable').innerHTML = html + "</table>";
        } catch (e) { 
            document.getElementById('partTable').innerHTML = "Ошибка загрузки участников"; 
        }
    }

    async function register() {
        const cId = parseInt(document.getElementById('compSel').value);
        const aId = parseInt(document.getElementById('athSel').value);

        if (!cId || !aId) return alert("Выберите соревнование и атлета!");

        const body = {
            competition_id: cId,
            athlete_id: aId,
            place: 0 // Передаем 0, так как бэкенд может ждать это поле
        };

        const res = await fetch(`${API}/participations`, { 
            method: 'POST', 
            headers: h(), 
            body: JSON.stringify(body) 
        });

        if (res.ok) {
            loadTable();
        } else {
            alert("Ошибка при регистрации участника");
        }
    }

    function openModal(id, athId, compId) {
        document.getElementById('editId').value = id;
        document.getElementById('editAthSel').value = athId;
        document.getElementById('editCompSel').value = compId;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function updateParticipation() {
        const id = document.getElementById('editId').value;
        const body = {
            competition_id: parseInt(document.getElementById('editCompSel').value),
            athlete_id: parseInt(document.getElementById('editAthSel').value),
            place: 0
        };

        const res = await fetch(`${API}/participations/${id}`, { 
            method: 'PUT', 
            headers: h(), 
            body: JSON.stringify(body) 
        });

        if (res.ok) { 
            closeModal(); 
            loadTable(); 
        } else { 
            alert("Ошибка при обновлении записи"); 
        }
    }

    async function delPart(id) {
        if (confirm("Вы действительно хотите удалить эту запись?")) {
            const res = await fetch(`${API}/participations/${id}`, { 
                method: 'DELETE', 
                headers: h() 
            });
            if (res.ok) loadTable();
        }
    }

    window.onload = init;
</script>
</body>
</html>