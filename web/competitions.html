<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление соревнованиями</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #333; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; }
        input, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; }
        .btn-add { background: #f6c23e; color: #333; width: 100%; margin-top: 15px; padding: 12px; font-weight: bold; border: none; cursor: pointer; }
        .btn-edit { background: #ffc107; color: #212529; margin-right: 5px; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-del { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .back-btn { background: #6c757d; color: white; text-decoration: none; padding: 8px 15px; display: inline-block; margin-bottom: 15px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #f6c23e; color: #333; }
        #editModal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 450px; }
        .modal-content label { display: block; margin-top: 10px; font-weight: bold; }
        .modal-content input { width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    </style>
</head>
<body>
<div class="container">
    <a href="index.html" class="back-btn">← Назад в меню</a>
    <div class="card">
        <h2>Создать соревнование</h2>
        <div class="form-grid">
            <input type="text" id="addName" placeholder="Название турнира">
            <input type="text" id="addLocation" placeholder="Место проведения">
            <input type="date" id="addDate">
        </div>
        <button class="btn-add" onclick="createComp()">Создать турнир</button>
    </div>
    <div class="card">
        <h2>Список соревнований</h2>
        <div id="compTable">Загрузка...</div>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>Редактировать соревнование</h3>
        <input type="hidden" id="editId">
        <label>Название:</label><input type="text" id="editName">
        <label>Место:</label><input type="text" id="editLocation">
        <label>Дата начала:</label><input type="date" id="editDate">
        <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
            <button onclick="closeModal()" style="background:#6c757d; color:white; flex: 1; padding: 10px;">Отмена</button>
            <button onclick="updateComp()" style="background:#28a745; color:white; flex: 1; padding: 10px;">Сохранить</button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api/v1';
    const h = () => ({ 'Authorization': `Bearer ${localStorage.getItem('token')}`, 'Content-Type': 'application/json' });

    async function load() {
        try {
            const res = await fetch(`${API_URL}/competitions`, { headers: h() });
            if (res.status === 401) window.location.replace('login.html');
            const data = await res.json();
            const list = data.competitions || data || [];
            let html = `<table><tr><th>Название</th><th>Место</th><th>Дата</th><th>Действия</th></tr>`;
            list.forEach(c => {
                const dateRaw = c.start_date || c.StartDate || c.date;
                const dateDisp = dateRaw ? new Date(dateRaw).toLocaleDateString() : '—';
                html += `<tr>
                    <td>${c.name}</td>
                    <td>${c.location || '—'}</td>
                    <td>${dateDisp}</td>
                    <td>
                        <button class="btn-edit" onclick="openModal(${c.id}, '${c.name}', '${c.location||''}', '${dateRaw||''}')">Изменить</button>
                        <button class="btn-del" onclick="deleteComp(${c.id})">Удалить</button>
                    </td>
                </tr>`;
            });
            document.getElementById('compTable').innerHTML = html + "</table>";
        } catch (e) { document.getElementById('compTable').innerHTML = "Ошибка загрузки"; }
    }

    async function createComp() {
        const d = document.getElementById('addDate').value;
        if (!d) return alert("Выберите дату!");
        const body = {
            name: document.getElementById('addName').value,
            location: document.getElementById('addLocation').value,
            start_date: new Date(d).toISOString()
        };
        const res = await fetch(`${API_URL}/competitions`, { method: 'POST', headers: h(), body: JSON.stringify(body) });
        if (res.ok) { load(); } else { alert("Ошибка создания"); }
    }

    function openModal(id, name, loc, date) {
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editLocation').value = loc;
        if(date) document.getElementById('editDate').value = date.split('T')[0];
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }

    async function updateComp() {
        const d = document.getElementById('editDate').value;
        const body = {
            name: document.getElementById('editName').value,
            location: document.getElementById('editLocation').value,
            start_date: d ? new Date(d).toISOString() : null
        };
        const res = await fetch(`${API_URL}/competitions/${document.getElementById('editId').value}`, { method: 'PUT', headers: h(), body: JSON.stringify(body) });
        if (res.ok) { closeModal(); load(); } else { alert("Ошибка обновления"); }
    }

    async function deleteComp(id) {
        if (confirm("Удалить?")) {
            await fetch(`${API_URL}/competitions/${id}`, { method: 'DELETE', headers: h() });
            load();
        }
    }
    window.onload = load;
</script>
</body>
</html>